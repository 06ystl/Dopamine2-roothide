//
//  badRecovery.h
//  Dopamine
//
//  Created by Lars Fr√∂der on 25.01.24.
//

#ifndef badRecovery_h
#define badRecovery_h

#include <stdint.h>
#include <stdbool.h>
#include <mach/mach.h>

typedef struct {
    uint64_t unk;
    uint64_t x[29];
    uint64_t fp;
    uint64_t lr;
    uint64_t sp;
    uint64_t pc;
    uint32_t cpsr;
    // Other stuff
    uint64_t other[70];
} kRegisterState;

typedef struct {
    bool inited;
    thread_t gExploitThread;
    uint64_t gScratchMemKern;
    volatile uint64_t *gScratchMemMapped;
    volatile uint64_t *gReturnValMemMapped;
    arm_thread_state64_t gExploitThreadState;
    uint64_t gSpecialMemRegion;
    uint64_t gIntStack;
    uint64_t gOrigIntStack;
    uint64_t gReturnContext;
    uint64_t gACTPtr;
    uint64_t gACTVal;
    uint64_t gCPUData;
} exploitThreadInfo;

typedef struct {
    bool inited;
    thread_t thread;
    uint64_t actContext;
    kRegisterState signedState;
    uint64_t kernelStack;
    kRegisterState *mappedState;
    uint64_t scratchMemory;
    uint64_t *scratchMemoryMapped;
} Fugu14KcallThread;

bool breakCFI(void);
void deinitFugu15PACBypass(void);

bool setupFugu14Kcall(void);

void pac_exploit_thread(void);
void pac_exploit_doIt(void);
void pac_loop(void);

void ppl_loop(void);
void ppl_done(void);

void kexec(kRegisterState *state, exploitThreadInfo *info);

bool kexec_on_new_thread(kRegisterState *kState, thread_t *thread);

uint64_t Fugu15Kcall(uint64_t func, int argc, const uint64_t *argv);
uint64_t Fugu14Kcall(uint64_t func, int argc, const uint64_t *argv);

#endif /* badRecovery_h */
